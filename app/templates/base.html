<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SW Testing Mini</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <header>
    <div class="topbar">
      <div class="logo"><div class="mark">ST</div><h1>SW Testing Mini</h1></div>
      <div class="acting">
        <label for="login-user-id" style="color:rgba(255,255,255,0.9);font-size:0.9rem;margin-right:0.5rem">Login as</label>
        <input id="login-user-id" placeholder="user id" style="width:5rem;padding:0.25rem;border-radius:6px;border:none;margin-right:0.25rem"/>
        <input id="login-password" placeholder="password" type="password" style="width:8rem;padding:0.25rem;border-radius:6px;border:none;margin-right:0.25rem"/>
        <button id="login-btn" class="ghost" style="margin-left:0.25rem">Login</button>
        <button id="logout-btn" class="ghost" style="margin-left:0.25rem">Logout</button>
      </div>
      <nav>
        <a href="/ui">Home</a>
        <a href="/ui">Dashboard</a>
      </nav>
    </div>
  </header>
  <main>
    <div class="container">
      {% block content %}{% endblock %}
    </div>
  </main>
  <!-- Toast container. Per-page toast payload is written into the data-toast attribute as JSON. -->
  <div id="toast-container" data-toast='{{ (toast|default(None))|tojson|safe }}' aria-live="polite" style="position:fixed;right:1rem;bottom:1rem;z-index:9999"></div>
  <script>
    // Toast manager: supports showToast(message|object) where object = {message, type, duration}
    function createToastElement(msg, type){
      const el = document.createElement('div');
      el.classList.add('toast', `toast--${type || 'info'}`);
      const inner = document.createElement('div');
      inner.className = 'toast-message';
      inner.textContent = msg;
      const btn = document.createElement('button');
      btn.className = 'toast-close';
      btn.setAttribute('aria-label','dismiss');
      btn.innerHTML = '&times;';
      btn.addEventListener('click', ()=>{ hideToast(el); });
      el.appendChild(inner);
      el.appendChild(btn);
      return el;
    }

    function hideToast(el){
      if(!el) return;
      el.classList.remove('toast-in');
      el.classList.add('toast-out');
      el.addEventListener('animationend', ()=> el.remove(), { once: true });
    }

    function showToast(payload){
      // payload may be string or object
      let msg=''; let type='info'; let duration=4000;
      if(typeof payload === 'string') msg = payload;
      else if (payload && typeof payload === 'object'){
        msg = payload.message || JSON.stringify(payload);
        type = payload.type || 'info';
        duration = (typeof payload.duration === 'number') ? payload.duration : duration;
      } else return;

      const container = document.getElementById('toast-container');
      const el = createToastElement(msg, type);
      container.appendChild(el);
      // start in animation
      requestAnimationFrame(()=> el.classList.add('toast-in'));

      // pause timer on hover
      let timeoutId = setTimeout(()=> hideToast(el), duration);
      el.addEventListener('mouseenter', ()=> clearTimeout(timeoutId));
      el.addEventListener('mouseleave', ()=> { timeoutId = setTimeout(()=> hideToast(el), Math.max(800, duration/3)); });
    }

    // On load, parse JSON from the data-toast attribute instead of relying on
    // inline template JS (this avoids editor JS parsing errors when templates
    // contain Jinja expressions).
    window.addEventListener('load', function(){
      try {
        const container = document.getElementById('toast-container');
        const raw = container && container.getAttribute('data-toast');
        let payload = null;
        if (raw && raw !== 'null') {
          payload = JSON.parse(raw);
        }
        if (payload) {
          showToast(payload);
        }
      } catch (e) {
        // don't crash the page for malformed JSON
        console.warn('Failed to parse toast payload', e);
      }
    });
    // acting user UI: persist to localStorage and expose a getter for other scripts
    (function(){
      const input = document.getElementById('acting-user-id');
      const btn = document.getElementById('acting-set');
      if(!input || !btn) return;
      const key = 'actingUserId';
      input.value = localStorage.getItem(key) || '';
      btn.addEventListener('click', ()=>{
        const v = input.value.trim();
        if(v) localStorage.setItem(key, v); else localStorage.removeItem(key);
        alert('Acting user id set to: ' + (v || '(none)'));
      });
      window.getActingUserId = function(){ return localStorage.getItem(key); };
    })();
    // Login form handling: request token from /auth/login and store in localStorage
    (function(){
      const idInput = document.getElementById('login-user-id');
      const pwInput = document.getElementById('login-password');
      const loginBtn = document.getElementById('login-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const key = 'authToken';
      function setToken(t){ if(t) localStorage.setItem(key, t); else localStorage.removeItem(key); }
      loginBtn && loginBtn.addEventListener('click', async ()=>{
        const uid = idInput.value.trim(); const pw = pwInput.value;
        if(!uid){ alert('enter user id'); return; }
        try{
          const res = await fetch('/auth/login', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({user_id: uid, password: pw || undefined})});
          if(!res.ok){ const j = await res.json().catch(()=>({})); alert('login failed: '+(j.detail||res.statusText)); return; }
          const j = await res.json(); setToken(j.access_token); alert('logged in');
        }catch(e){ alert('login failed'); }
      });
      logoutBtn && logoutBtn.addEventListener('click', ()=>{ setToken(null); alert('logged out'); });
      window.getAuthToken = function(){ return localStorage.getItem(key); };
      window.getAuthHeader = function(){ const t = window.getAuthToken(); return t ? {'Authorization':'Bearer '+t} : {}; };
    })();
  </script>
  <footer>
    Built for testing examples Â· Toggle vulnerability mode on the UI to explore safe vs vulnerable behavior. See README for test snippets.
  </footer>
</body>
</html>
